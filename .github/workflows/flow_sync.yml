name: Flow sync-documentation pipeline

# TODO: This is almost a copy/paste of ./flow_ipc_sync.yml, just applied to different repo.
# Add some kind of code reuse ideally.  For now keeping comments light in this one, as it mirrors the other one.

on:
  # An API request can trigger us; so Code (source) repo can invoke us after generating docs and checking those
  # in to itself.
  repository_dispatch:
    types: [flow-sync-doc-event]
  # To create the button that runs a workflow manually:
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:

    # Write access is required later, so at least 1 way to allow it is under Settings/Actions/General
    # set "Workflow permissions" to "Read and write permissions" (may need similar org-wide change first).
    - name: Checkout Pages repo (the destination)
      uses: actions/checkout@v4
      with:
        path: 'dst_repo'
        sparse-checkout: 'doc/flow/versions'

    - name: Checkout Code repo (the source)
      uses: actions/checkout@v4
      with:
        repository: 'Flow-IPC/flow'
        path: 'src_repo'
        sparse-checkout: 'doc/flow_doc'

    - name: Replace Pages (destination) docs with copy of Code (source) docs
      run: |
        # Replace Pages (destination) docs with copy of Code (source) docs.
        cd dst_repo
        DOC_DIR=doc/flow/versions
        BRANCH=main
        rm -rf $DOC_DIR/$BRANCH
        mkdir -p $DOC_DIR
        cp -rv ../src_repo/doc/flow_doc $DOC_DIR/$BRANCH
        # These values informally recommended in:
        #   https://github.com/actions/checkout#push-a-commit-using-the-built-in-token
        git config user.name github-actions
        git config user.email github-actions@github.com
        git rm -r --cached $DOC_DIR/$BRANCH || echo "No [$DOC_DIR/$BRANCH] currently checked in; no problem."
        git add $DOC_DIR/$BRANCH
        git commit -m 'Sync documentation from Code repo to Pages repo.' || echo 'No changes: no problem.'
        git push origin main
